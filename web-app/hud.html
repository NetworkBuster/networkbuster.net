<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetworkBuster Function HUD</title>
    <style>
        :root {
            color-scheme: dark;
            --bg: #0b1220;
            --panel: #111a2f;
            --accent: #58d5ff;
            --accent-2: #8a5dff;
            --text: #e8f0ff;
            --muted: #8aa2c0;
            --success: #63e6be;
            --warn: #f7c948;
            --danger: #ff6b6b;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Space Mono', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: radial-gradient(circle at 20% 20%, rgba(88,213,255,0.08), transparent 30%),
                        radial-gradient(circle at 80% 0%, rgba(138,93,255,0.12), transparent 25%),
                        var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 24px;
        }
        h1 { margin: 0 0 8px 0; font-size: 26px; letter-spacing: 0.5px; }
        p { margin: 4px 0 12px 0; color: var(--muted); }
        .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
        .panel {
            background: linear-gradient(145deg, var(--panel), #0c1527 60%);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.35);
        }
        .panel h2 { margin: 0 0 12px 0; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; color: #cdd9ff; }
        .status-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-top: 1px solid rgba(255,255,255,0.05); }
        .status-row:first-child { border-top: none; }
        .chip { padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; letter-spacing: 0.4px; }
        .chip.ok { background: rgba(99,230,190,0.15); color: var(--success); border: 1px solid rgba(99,230,190,0.5); }
        .chip.warn { background: rgba(247,201,72,0.12); color: var(--warn); border: 1px solid rgba(247,201,72,0.5); }
        .chip.err { background: rgba(255,107,107,0.12); color: var(--danger); border: 1px solid rgba(255,107,107,0.4); }
        .latency { color: var(--muted); font-size: 12px; margin-left: 10px; }
        .list { display: grid; gap: 10px; }
        .link-card { padding: 10px 12px; border-radius: 10px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); }
        .link-card a { color: var(--text); text-decoration: none; font-weight: 600; }
        .link-card small { display: block; color: var(--muted); margin-top: 4px; }
        .log-box { background: #0a0f1a; border-radius: 12px; padding: 12px; border: 1px solid rgba(255,255,255,0.06); height: 260px; overflow: auto; font-family: 'Space Mono', monospace; font-size: 12px; line-height: 1.4; color: #c5d7ff; }
        .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        button {
            background: linear-gradient(120deg, var(--accent), var(--accent-2));
            color: #0a0f1a;
            border: none;
            padding: 10px 14px;
            border-radius: 10px;
            font-weight: 700;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        button:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(88,213,255,0.25); }
        button.secondary { background: rgba(255,255,255,0.05); color: var(--text); border: 1px solid rgba(255,255,255,0.08); }
        .subtle { color: var(--muted); font-size: 12px; margin-top: 6px; }
    </style>
</head>
<body>
    <header style="margin-bottom:20px;">
        <h1>Function HUD</h1>
        <p>Health + latency checks, static function map, and live log snippets.</p>
        <div class="actions">
            <button id="refreshChecks">Run Checks</button>
            <button class="secondary" id="refreshLogs">Refresh Logs</button>
        </div>
        <div class="subtle">Checks poll every 15s; logs refresh every 20s.</div>
    </header>

    <div class="grid" style="margin-bottom:16px;">
        <div class="panel" id="statusPanel">
            <h2>Status & Latency</h2>
            <div id="statusRows"></div>
        </div>
        <div class="panel">
            <h2>Function Map</h2>
            <div class="list" id="functionList"></div>
        </div>
    </div>

    <div class="panel">
        <h2>Live Logs</h2>
        <div class="log-box" id="logsBox">Loading logsâ€¦</div>
    </div>

    <script>
        const checks = [
            { key: 'health', label: 'API Health', url: '/api/health' },
            { key: 'status', label: 'API Status', url: '/api/status' },
            { key: 'components', label: 'Components', url: '/api/components' },
            { key: 'overlay', label: 'Overlay', url: '/overlay' },
            { key: 'dashboard', label: 'Dashboard', url: '/dashboard' },
            { key: 'blog', label: 'Blog', url: '/blog' }
        ];

        const functions = [
            { name: 'API Health', path: '/api/health', desc: 'Basic health probe' },
            { name: 'API Status', path: '/api/status', desc: 'Runtime + system info' },
            { name: 'Components', path: '/api/components', desc: 'Service map snapshot' },
            { name: 'Logs', path: '/api/logs', desc: 'Recent log buffer (read-only)' },
            { name: 'Overlay', path: '/overlay', desc: 'NASA challenge overlay (Vite build)' },
            { name: 'Dashboard', path: '/dashboard', desc: 'Analytics dashboard (SPA)' },
            { name: 'Control Panel', path: '/control-panel', desc: 'Ops controls + EQ' }
        ];

        function renderFunctions() {
            const list = document.getElementById('functionList');
            list.innerHTML = functions.map(fn => `
                <div class="link-card">
                    <a href="${fn.path}">${fn.name}</a>
                    <small>${fn.desc}</small>
                </div>
            `).join('');
        }

        async function pingEndpoint(check) {
            const start = performance.now();
            const controller = new AbortController();
            const timer = setTimeout(() => controller.abort(), 8000);
            try {
                const res = await fetch(check.url, { cache: 'no-store', signal: controller.signal });
                clearTimeout(timer);
                const latency = Math.round(performance.now() - start);
                if (!res.ok) throw new Error('bad status ' + res.status);
                return { status: 'ok', latency };
            } catch (err) {
                clearTimeout(timer);
                const latency = Math.round(performance.now() - start);
                return { status: 'err', latency, message: err.message };
            }
        }

        function renderStatus(results) {
            const container = document.getElementById('statusRows');
            container.innerHTML = results.map(r => `
                <div class="status-row">
                    <div>
                        <strong>${r.label}</strong>
                        <span class="latency">${r.latency} ms</span>
                        ${r.message ? `<div class="subtle">${r.message}</div>` : ''}
                    </div>
                    <span class="chip ${r.status === 'ok' ? 'ok' : 'err'}">${r.status === 'ok' ? 'ONLINE' : 'ISSUE'}</span>
                </div>
            `).join('');
        }

        async function runChecks() {
            const results = [];
            for (const check of checks) {
                const result = await pingEndpoint(check);
                results.push({ ...check, ...result });
            }
            renderStatus(results);
        }

        async function loadLogs() {
            try {
                const res = await fetch('/api/logs', { cache: 'no-store' });
                if (!res.ok) throw new Error('Log fetch failed');
                const data = await res.json();
                const logs = (data.logs || []).slice(-80).reverse();
                document.getElementById('logsBox').textContent = logs.join('\n') || 'No logs yet.';
            } catch (err) {
                document.getElementById('logsBox').textContent = `Failed to load logs: ${err.message}`;
            }
        }

        document.getElementById('refreshChecks').addEventListener('click', runChecks);
        document.getElementById('refreshLogs').addEventListener('click', loadLogs);

        renderFunctions();
        runChecks();
        loadLogs();
        setInterval(runChecks, 15000);
        setInterval(loadLogs, 20000);
    </script>
</body>
</html>
