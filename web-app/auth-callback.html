<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Callback | NetworkBuster</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            text-align: center;
        }
        .container {
            padding: 2rem;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .message {
            color: rgba(255,255,255,0.7);
        }
        .success {
            color: #4ade80;
        }
        .error {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner" id="spinner"></div>
        <p class="message" id="message">Processing authentication...</p>
    </div>
    
    <script>
        // Parse the URL hash for the access token
        function getHashParams() {
            const hash = window.location.hash.substring(1);
            const params = {};
            hash.split('&').forEach(pair => {
                const [key, value] = pair.split('=');
                if (key) params[key] = decodeURIComponent(value);
            });
            return params;
        }
        
        // Fetch user info from Google
        async function getUserInfo(accessToken) {
            const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });
            return response.json();
        }
        
        async function handleCallback() {
            const messageEl = document.getElementById('message');
            const spinnerEl = document.getElementById('spinner');
            
            try {
                const params = getHashParams();
                
                if (params.access_token) {
                    messageEl.textContent = 'Fetching user info...';
                    
                    const userInfo = await getUserInfo(params.access_token);
                    
                    // Send to parent window
                    if (window.opener) {
                        window.opener.postMessage({
                            type: 'google-auth-success',
                            token: params.access_token,
                            user: userInfo
                        }, '*');
                        
                        spinnerEl.style.display = 'none';
                        messageEl.className = 'message success';
                        messageEl.textContent = 'âœ“ Authentication successful! This window will close...';
                        
                        setTimeout(() => window.close(), 1500);
                    } else {
                        throw new Error('Parent window not found');
                    }
                } else if (params.error) {
                    throw new Error(params.error_description || params.error);
                } else {
                    throw new Error('No authentication response received');
                }
            } catch (error) {
                spinnerEl.style.display = 'none';
                messageEl.className = 'message error';
                messageEl.textContent = `Authentication failed: ${error.message}`;
                
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'google-auth-error',
                        error: error.message
                    }, '*');
                }
                
                setTimeout(() => window.close(), 3000);
            }
        }
        
        // Run on page load
        handleCallback();
    </script>
</body>
</html>
