name: Integration Test

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  integration:
    runs-on: ubuntu-latest
    services:
      mosquitto:
        image: eclipse-mosquitto:2.0.15
        ports:
          - 1883:1883
        options: >-
          --tmpfs /mosquitto/config --tmpfs /mosquitto/data
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install paho-mqtt
      - name: Wait for Mosquitto
        run: |
          echo 'Waiting for broker to be ready...'
          for i in {1..20}; do nc -z localhost 1883 && echo ok && exit 0 || sleep 1; done
          echo 'Broker not ready' && exit 1
      - name: Run integration test
        run: python ci/integration_test.py --broker 127.0.0.1 --port 1883
