name: Test OpenAI secret âœ…

on:
  workflow_dispatch: {}
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  actions: read

jobs:
  check-openai-key:
    name: Check OPENAI_API_KEY
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure OPENAI_API_KEY secret exists
        run: |
          if [ -z "${OPENAI_API_KEY}" ]; then
            echo "ERROR: OPENAI_API_KEY is not set in repository secrets" >&2
            exit 1
          fi
          echo "OPENAI_API_KEY appears set (will not print the value)"

      - name: Validate OpenAI API key by calling Models endpoint
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -o pipefail
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $OPENAI_API_KEY" https://api.openai.com/v1/models || true)
          echo "HTTP status: $STATUS"
          if [ "$STATUS" != "200" ]; then
            echo "OpenAI API request failed with status $STATUS" >&2
            exit 1
          fi
          echo "OpenAI API key validation succeeded (HTTP 200)."
